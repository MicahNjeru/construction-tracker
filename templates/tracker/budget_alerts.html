{% extends 'base.html' %}

{% block title %}Budget Alerts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-bell"></i> Budget Alerts</h1>
        {% if unread_count > 0 %}
        <span class="badge bg-danger">{{ unread_count }} Unread</span>
        {% endif %}
    </div>
</div>

{% if alerts %}
<div class="list-group">
    {% for alert in alerts %}
    <div class="list-group-item {% if not alert.is_read %}list-group-item-warning{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-{% if alert.alert_type == 'exceeded' %}exclamation-octagon text-danger{% elif alert.alert_type == 'critical' %}exclamation-triangle text-warning{% else %}info-circle text-info{% endif %} me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="mb-0">{{ alert.get_alert_type_display }}</h5>
                        <small class="text-muted">{{ alert.created_at|timesince }} ago</small>
                    </div>
                </div>
                <p class="mb-2">{{ alert.message }}</p>
                <a href="{% url 'project_detail' alert.project.pk %}" class="btn btn-sm btn-outline-primary">
                    View Project: {{ alert.project.name }}
                </a>
            </div>
            {% if not alert.is_read %}
            <button class="btn btn-sm btn-success mark-read" data-alert-id="{{ alert.pk }}">
                <i class="bi bi-check"></i> Mark Read
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center my-5">
    <i class="bi bi-bell-slash" style="font-size: 5rem; color: #ccc;"></i>
    <h3 class="mt-3">No Alerts</h3>
    <p class="text-muted">You'll be notified here when budgets reach warning thresholds.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.mark-read').forEach(button => {
    button.addEventListener('click', function() {
        const alertId = this.dataset.alertId;
        fetch(`/alerts/${alertId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              }
          });
    });
});
</script>
{% endblock %}